<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rios - Sistema Escolar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-book"></i> Sistema Escolar
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="bi bi-house-door"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="alunos.html">
              <i class="bi bi-people"></i> Alunos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="professores.html">
              <i class="bi bi-person-badge"></i> Professores
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="turmas.html">
              <i class="bi bi-collection"></i> Turmas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="disciplinas.html">
              <i class="bi bi-journal-text"></i> Disciplinas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="notas.html">
              <i class="bi bi-clipboard-check"></i> Notas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="relatorios.html">
              <i class="bi bi-bar-chart"></i> Relat√≥rios
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container py-4">
    <div class="row mb-4">
      <div class="col">
        <h1 class="h3">
          <i class="bi bi-bar-chart-fill"></i> Relat√≥rios e Estat√≠sticas
        </h1>
        <p class="text-muted">An√°lises e consultas do sistema escolar</p>
      </div>
    </div>

    <!-- Seletor de Relat√≥rio -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h6 class="card-title mb-3">
          <i class="bi bi-filter"></i> Selecione o Relat√≥rio
        </h6>
        <div class="row g-3">
          <div class="col-md-8">
            <select class="form-select" id="tipoRelatorio" onchange="alternarFiltroTurma()">
              <option value="geral">Estat√≠sticas Gerais</option>
              <option value="alunos-turma">Alunos por Turma</option>
              <option value="notas-disciplina">Notas por Disciplina</option>
              <option value="desempenho-alunos">Desempenho dos Alunos (M√©dia Global)</option>
              <option value="professores-turmas">Professores e Turmas</option>
            </select>
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" onclick="gerarRelatorio()">
              <i class="bi bi-file-earmark-bar-graph"></i> Gerar Relat√≥rio
            </button>
          </div>
        </div>
        <!-- NOVO FILTRO DIN√ÇMICO -->
        <div class="row g-3 mt-3" id="filtroTurmaContainer" style="display:none;">
            <div class="col-md-12">
                <label for="filtroTurma" class="form-label">Selecione a Turma</label>
                <select class="form-select" id="filtroTurma">
                    <option value="">Carregando Turmas...</option>
                </select>
            </div>
        </div>
      </div>
    </div>

    <!-- √Årea de Exibi√ß√£o do Relat√≥rio -->
    <div id="relatorioContainer">
      <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i> Selecione um relat√≥rio acima para visualizar
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    // Confirma√ß√£o de que o caminho √© `./assets/js/api.js`
    import { api, feedback } from './assets/js/api.js';

    // Dados de Cache
    let alunos = [];
    let professores = [];
    let turmas = [];
    let disciplinas = [];
    let notas = []; // Notas s√≥ s√£o usadas para o Relat√≥rio Geral

    /**
     * Carrega os dados cadastrais b√°sicos.
     * Alunos e Notas n√£o s√£o carregados aqui para evitar sobrecarga,
     * exceto para o Relat√≥rio Geral.
     */
    async function carregarDados() {
      try {
        [professores, turmas, disciplinas] = await Promise.all([
          api.get('/professores/'),
          api.get('/turmas/'),
          api.get('/disciplinas/'),
        ]);

        // Preencher o seletor de turmas
        const selectTurma = document.getElementById('filtroTurma');
        selectTurma.innerHTML = '<option value="">Selecione uma Turma</option>' +
          turmas.map(t => `<option value="${t.id}">${t.nome} - ${t.ano}</option>`).join('');

      } catch (error) {
        console.error('Erro ao carregar dados cadastrais:', error);
        feedback.error('Erro ao carregar dados cadastrais para relat√≥rios');
      }
    }

    /**
     * Alterna a visibilidade do seletor de turma
     */
    window.alternarFiltroTurma = function() {
      const tipo = document.getElementById('tipoRelatorio').value;
      const container = document.getElementById('filtroTurmaContainer');
      
      if (tipo === 'alunos-turma') {
        container.style.display = 'flex';
      } else {
        container.style.display = 'none';
      }
    };

    /**
     * Gera relat√≥rio selecionado
     */
    window.gerarRelatorio = async function() {
      const tipo = document.getElementById('tipoRelatorio').value;
      const container = document.getElementById('relatorioContainer');

      container.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Gerando relat√≥rio...</span>
          </div>
        </div>
      `;

      // Recarrega apenas os cadastros base (se necess√°rio)
      if (professores.length === 0) {
        await carregarDados();
      }

      switch(tipo) {
        case 'geral':
          // Requisita todas as notas e alunos apenas para o relat√≥rio geral
          [alunos, notas] = await Promise.all([api.get('/alunos/'), api.get('/notas/')]);
          container.innerHTML = gerarRelatorioGeral();
          break;
        case 'alunos-turma':
          const turmaId = document.getElementById('filtroTurma').value;
          if (!turmaId) {
            container.innerHTML = `<div class="alert alert-warning text-center">Selecione uma turma para gerar o relat√≥rio.</div>`;
            return;
          }
          container.innerHTML = await gerarRelatorioAlunosPorTurma(turmaId);
          break;
        case 'notas-disciplina':
          [alunos, notas] = await Promise.all([api.get('/alunos/'), api.get('/notas/')]);
          container.innerHTML = gerarRelatorioNotasPorDisciplina();
          break;
        case 'desempenho-alunos':
           // Para desempenho, precisamos da lista de alunos (que j√° traz a m√©dia dinamicamente)
          alunos = await api.get('/alunos/'); 
          container.innerHTML = gerarRelatorioDesempenhoAlunos();
          break;
        case 'professores-turmas':
          container.innerHTML = gerarRelatorioProfessoresTurmas();
          break;
      }
    };

    /**
     * Relat√≥rio: Estat√≠sticas Gerais
     */
    function gerarRelatorioGeral() {
      // C√°lculo da M√©dia Global no Frontend (aceit√°vel para relat√≥rios simples)
      const mediaGeral = notas.length > 0
        ? (notas.reduce((sum, n) => sum + parseFloat(n.valor), 0) / notas.length).toFixed(2)
        : '0.00';
      
      const alunosAtivos = alunos.filter(a => a.status === 'Ativo').length;
      const professoresAtivos = professores.filter(p => p.ativo).length;

      return `
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estat√≠sticas Gerais</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6>Total de Alunos</h6>
                    <h2 class="text-primary">${alunos.length}</h2>
                    <small class="text-muted">Ativos: ${alunosAtivos}</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6>Total de Professores</h6>
                    <h2 class="text-success">${professores.length}</h2>
                    <small class="text-muted">Ativos: ${professoresAtivos}</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6>Total de Turmas</h6>
                    <h2 class="text-warning">${turmas.length}</h2>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6>M√©dia Geral</h6>
                    <h2 class="text-danger">${mediaGeral}</h2>
                    <small class="text-muted">${notas.length} notas</small>
                  </div>
                </div>
              </div>
            </div>
            <hr>
            <h6 class="mt-4">Disciplinas (${disciplinas.length})</h6>
            <div class="row">
              ${disciplinas.map(d => `
                <div class="col-md-4 mb-2">
                  <span class="badge bg-info">${d.nome}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    /**
     * Relat√≥rio: Alunos por Turma (BUSCA OTIMIZADA VIA API)
     * Requer o endpoint customizado: /turmas/{id}/alunos/
     */
    async function gerarRelatorioAlunosPorTurma(turmaId) {
        // Busca a turma e os alunos da turma via API customizada
        const [turma, alunosDaTurma] = await Promise.all([
            api.get(`/turmas/${turmaId}/`),
            api.get(`/turmas/${turmaId}/alunos/`)
        ]);

        const professor = professores.find(p => p.turma_responsavel === turma.id);
        
        return `
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Alunos por Turma: ${turma.nome} - ${turma.ano}</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3"><strong>Professor Respons√°vel:</strong> ${professor ? professor.nome_completo : '<em class="text-muted">N√£o definido</em>'}</p>
                    
                    ${alunosDaTurma.length > 0 ? `
                      <div class="table-responsive">
                        <table class="table table-sm table-striped">
                          <thead>
                            <tr>
                              <th>Nome</th>
                              <th>CPF</th>
                              <th>Status</th>
                              <th>M√©dia Global</th>
                              <th>M√©dias por Disciplina</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${alunosDaTurma.map(aluno => {
                                // Assume que o aluno.media_geral existe via @property
                                const mediaGeral = aluno.media_geral !== undefined ? aluno.media_geral.toFixed(2) : 'N/D';
                                // Assume que medias_por_disciplina existe via SerializerMethodField
                                const mediasDisciplinas = aluno.medias_por_disciplina 
                                    ? aluno.medias_por_disciplina.map(m => 
                                        `<span class="badge bg-secondary me-1">${m.disciplina}: ${m.media.toFixed(2)}</span>`
                                      ).join('')
                                    : 'N√£o calculada';

                                return `
                                  <tr>
                                    <td>${aluno.nome_completo}</td>
                                    <td>${formatarCPF(aluno.cpf)}</td>
                                    <td><span class="badge bg-${aluno.status === 'Ativo' ? 'success' : 'secondary'}">${aluno.status}</span></td>
                                    <td><span class="badge bg-info fs-6">${mediaGeral}</span></td>
                                    <td>${mediasDisciplinas}</td>
                                  </tr>
                                `;
                            }).join('')}
                          </tbody>
                        </table>
                      </div>
                    ` : '<p class="text-muted">Nenhum aluno matriculado</p>'}
                </div>
            </div>
        `;
    }

    /**
     * Relat√≥rio: Notas por Disciplina (Mant√©m a l√≥gica local)
     */
    function gerarRelatorioNotasPorDisciplina() {
      // Requer que 'alunos' e 'notas' tenham sido carregados no gerarRelatorio()
      if (alunos.length === 0 || notas.length === 0) return `<div class="alert alert-warning text-center">Nenhuma nota ou aluno para calcular.</div>`;
      
      return `
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-journal-text"></i> Notas por Disciplina</h5>
          </div>
          <div class="card-body">
            ${disciplinas.map(disciplina => {
              const notasDisciplina = notas.filter(n => n.disciplina === disciplina.id);
              const media = notasDisciplina.length > 0
                ? (notasDisciplina.reduce((sum, n) => sum + parseFloat(n.valor), 0) / notasDisciplina.length).toFixed(2)
                : '0.00';
              
              const aprovados = notasDisciplina.filter(n => parseFloat(n.valor) >= 7).length;
              const recuperacao = notasDisciplina.filter(n => parseFloat(n.valor) >= 5 && parseFloat(n.valor) < 7).length;
              const reprovados = notasDisciplina.filter(n => parseFloat(n.valor) < 5).length;

              return `
                <div class="mb-4">
                  <h6 class="bg-light p-2 rounded">
                    <i class="bi bi-book"></i> ${disciplina.nome}
                    <span class="badge bg-secondary float-end">${notasDisciplina.length} notas</span>
                  </h6>
                  ${notasDisciplina.length > 0 ? `
                    <div class="row g-3 mb-3">
                      <div class="col-md-3">
                        <div class="card bg-light">
                          <div class="card-body text-center p-2">
                            <small>M√©dia</small>
                            <h5 class="mb-0">${media}</h5>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-success text-white">
                          <div class="card-body text-center p-2">
                            <small>Aprovados (‚â•7)</small>
                            <h5 class="mb-0">${aprovados}</h5>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning">
                          <div class="card-body text-center p-2">
                            <small>Recupera√ß√£o (5-6.9)</small>
                            <h5 class="mb-0">${recuperacao}</h5>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-danger text-white">
                          <div class="card-body text-center p-2">
                            <small>Reprovados (<5)</small>
                            <h5 class="mb-0">${reprovados}</h5>
                          </div>
                        </div>
                      </div>
                    </div>
                  ` : '<p class="text-muted">Nenhuma nota lan√ßada</p>'}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    /**
     * Relat√≥rio: Desempenho dos Alunos (AGORA CONFIA NO BACKEND PARA media_geral)
     */
    function gerarRelatorioDesempenhoAlunos() {
      // Requer que 'alunos' tenha sido carregado no gerarRelatorio()
      if (alunos.length === 0) return `<div class="alert alert-warning text-center">Nenhum aluno cadastrado.</div>`;

      // Simplesmente usa a m√©dia vinda do Serializer (propriedade din√¢mica)
      const alunosComMedia = alunos.map(aluno => {
          // Garante que a media_geral seja tratada como float para a ordena√ß√£o
          const media = parseFloat(aluno.media_geral) || 0.00;
          return {
              ...aluno,
              mediaCalculada: media
          };
      }).sort((a, b) => b.mediaCalculada - a.mediaCalculada);

      return `
        <div class="card shadow-sm">
          <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="bi bi-trophy"></i> Desempenho dos Alunos (Global)</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Posi√ß√£o</th>
                    <th>Nome</th>
                    <th>Turma</th>
                    <th>M√©dia Global</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${alunosComMedia.map((aluno, index) => {
                    const turma = turmas.find(t => t.id === aluno.turma);
                    const statusNota = aluno.mediaCalculada >= 7 ? 'success' : 
                                      aluno.mediaCalculada >= 5 ? 'warning' : 'danger';
                    const posicao = index + 1;
                    const medalha = posicao === 1 ? 'ü•á' : posicao === 2 ? 'ü•à' : posicao === 3 ? 'ü•â' : posicao;

                    return `
                      <tr>
                        <td><strong>${medalha}</strong></td>
                        <td>${aluno.nome_completo}</td>
                        <td>${turma ? turma.nome : 'N/A'}</td>
                        <td><span class="badge bg-${statusNota} fs-6">${aluno.mediaCalculada.toFixed(2)}</span></td>
                        <td><span class="badge bg-${aluno.status === 'Ativo' ? 'success' : 'secondary'}">${aluno.status}</span></td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * Relat√≥rio: Professores e Turmas
     */
    function gerarRelatorioProfessoresTurmas() {
      // Requer que 'alunos' seja carregado (fazendo a requisi√ß√£o aqui, se necess√°rio)
      // Como alunos foi carregado para 'geral' ou 'desempenho', usaremos a lista em cache.
      const alunos_temp = alunos.length > 0 ? alunos : [];

      return `
        <div class="card shadow-sm">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-person-badge"></i> Professores e Turmas</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Especializa√ß√£o</th>
                    <th>Turma Respons√°vel</th>
                    <th>Alunos</th>
                    <th>Data Contrata√ß√£o</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${professores.map(professor => {
                    const turma = turmas.find(t => t.id === professor.turma_responsavel);
                    // Usa a lista de alunos (temp)
                    const alunosDaTurma = turma ? alunos_temp.filter(a => a.turma === turma.id).length : 0;

                    return `
                      <tr>
                        <td><strong>${professor.nome_completo}</strong></td>
                        <td><span class="badge bg-info">${professor.area_especializacao}</span></td>
                        <td>${turma ? `${turma.nome} - ${turma.ano}` : '<em class="text-muted">Nenhuma</em>'}</td>
                        <td>${alunosDaTurma > 0 ? `<span class="badge bg-primary">${alunosDaTurma}</span>` : '-'}</td>
                        <td>${formatarData(professor.data_contratacao)}</td>
                        <td><span class="badge bg-${professor.ativo ? 'success' : 'secondary'}">${professor.ativo ? 'Ativo' : 'Inativo'}</span></td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * Formatar CPF
     */
    function formatarCPF(cpf) {
      if (!cpf) return 'N/A';
      // Assume que o CPF √© uma string de 11 d√≠gitos
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    /**
     * Formatar data
     */
    function formatarData(data) {
      if (!data) return 'N/A';
      return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
    }

    // Inicializar
    carregarDados();
  </script>
</body>
</html>