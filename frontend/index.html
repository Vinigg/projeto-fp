<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gestão Escolar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-book"></i> Sistema Escolar
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" href="index.html">
              <i class="bi bi-house-door"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="alunos.html">
              <i class="bi bi-people"></i> Alunos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="professores.html">
              <i class="bi bi-person-badge"></i> Professores
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="turmas.html">
              <i class="bi bi-collection"></i> Turmas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="disciplinas.html">
              <i class="bi bi-journal-text"></i> Disciplinas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="notas.html">
              <i class="bi bi-clipboard-check"></i> Notas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="relatorios.html">
              <i class="bi bi-bar-chart"></i> Relatórios
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container py-4">
    <div class="row mb-4">
      <div class="col">
        <h1 class="h3">
          <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
        <p class="text-muted">Visão geral do sistema escolar</p>
      </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row g-3 mb-4" id="dashboardCards">
      <!-- Cards serão inseridos via JavaScript -->
    </div>

    <!-- Informações Adicionais -->
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <i class="bi bi-info-circle"></i> Acesso Rápido
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              <a href="alunos.html" class="list-group-item list-group-item-action">
                <i class="bi bi-person-plus"></i> Cadastrar Novo Aluno
              </a>
              <a href="professores.html" class="list-group-item list-group-item-action">
                <i class="bi bi-person-plus-fill"></i> Cadastrar Novo Professor
              </a>
              <a href="turmas.html" class="list-group-item list-group-item-action">
                <i class="bi bi-plus-square"></i> Criar Nova Turma
              </a>
              <a href="notas.html" class="list-group-item list-group-item-action">
                <i class="bi bi-clipboard-plus"></i> Lançar Notas
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <i class="bi bi-graph-up"></i> Últimas Atividades
          </div>
          <div class="card-body">
            <div id="atividadesRecentes">
              <p class="text-muted">Carregando atividades...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-5 py-3 bg-light border-top">
    <div class="container text-center text-muted">
      <small>Sistema de Gestão Escolar - 2025</small>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { api, feedback } from './assets/js/api.js';

    /**
     * Carrega estatísticas do dashboard
     */
    async function carregarDashboard() {
      try {
        // Buscar dados em paralelo
        const [alunos, professores, turmas, disciplinas, notas] = await Promise.all([
          api.get('/alunos/'),
          api.get('/professores/'),
          api.get('/turmas/'),
          api.get('/disciplinas/'),
          api.get('/notas/')
        ]);

        // Calcular média geral das notas
        const mediaGeral = notas.length > 0
          ? (notas.reduce((sum, nota) => sum + parseFloat(nota.valor), 0) / notas.length).toFixed(2)
          : '0.00';

        // Dados dos cards
        const cards = [
          {
            titulo: 'Alunos',
            total: alunos.length,
            link: 'alunos.html',
            icon: 'bi-people-fill',
            color: 'primary'
          },
          {
            titulo: 'Professores',
            total: professores.length,
            link: 'professores.html',
            icon: 'bi-person-badge-fill',
            color: 'success'
          },
          {
            titulo: 'Turmas',
            total: turmas.length,
            link: 'turmas.html',
            icon: 'bi-collection-fill',
            color: 'warning'
          },
          {
            titulo: 'Disciplinas',
            total: disciplinas.length,
            link: 'disciplinas.html',
            icon: 'bi-journal-text',
            color: 'info'
          },
          {
            titulo: 'Notas Lançadas',
            total: notas.length,
            link: 'notas.html',
            icon: 'bi-clipboard-check-fill',
            color: 'secondary'
          },
          {
            titulo: 'Média Geral',
            total: mediaGeral,
            link: 'relatorios.html',
            icon: 'bi-graph-up-arrow',
            color: 'danger'
          }
        ];

        // Renderizar cards
        const container = document.getElementById('dashboardCards');
        container.innerHTML = cards.map(card => `
          <div class="col-md-4 col-lg-2">
            <div class="card text-white bg-${card.color} shadow-sm h-100">
              <div class="card-body text-center">
                <i class="bi ${card.icon} display-4 mb-2"></i>
                <h5 class="card-title">${card.titulo}</h5>
                <p class="card-text display-6 fw-bold">${card.total}</p>
                <a href="${card.link}" class="btn btn-light btn-sm">Ver mais</a>
              </div>
            </div>
          </div>
        `).join('');

        // Renderizar últimas atividades
        renderizarAtividades(alunos, notas);

      } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        feedback.error('Erro ao carregar dados do dashboard. Verifique se o servidor está rodando.');
      }
    }

    /**
     * Renderiza últimas atividades
     */
    function renderizarAtividades(alunos, notas) {
      const container = document.getElementById('atividadesRecentes');
      
      // Últimos 5 alunos cadastrados
      const ultimosAlunos = alunos.slice(-5).reverse();
      
      // Últimas 5 notas lançadas
      const ultimasNotas = notas.slice(-5).reverse();

      let html = '<h6 class="mb-3">Últimos Alunos Cadastrados</h6>';
      html += '<ul class="list-unstyled">';
      
      ultimosAlunos.forEach(aluno => {
        html += `<li class="mb-2"><i class="bi bi-person-check text-success"></i> ${aluno.nome_completo}</li>`;
      });
      
      html += '</ul>';

      if (ultimasNotas.length > 0) {
        html += '<h6 class="mb-3 mt-3">Últimas Notas Lançadas</h6>';
        html += '<ul class="list-unstyled">';
        
        ultimasNotas.forEach(nota => {
          html += `<li class="mb-2"><i class="bi bi-clipboard-check text-primary"></i> Nota: ${nota.valor}</li>`;
        });
        
        html += '</ul>';
      }

      container.innerHTML = html;
    }

    // Inicializar dashboard
    carregarDashboard();
  </script>
</body>
</html>
